<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska Elite - Professional Tasks</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background: #FFFFFF; min-height: 100vh; color: #000000; }
        .navbar { background: #FFFFFF; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 1rem 2rem; position: fixed; top: 0; width: 100%; z-index: 1000; }
        .dashboard-content { padding: 5rem 2rem; margin-top: 60px; }
        .dashboard-section h1 { font-size: 2.5rem; color: #000000; margin-bottom: 1rem; }
        .dashboard-section p { font-size: 1.2rem; color: #000000; margin-bottom: 2rem; }
        .tasks-section h2, .new-task-section h2 { font-size: 1.8rem; color: #000000; margin-bottom: 1.5rem; }
        .tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .task-card { background: #FFFFFF; border-radius: 15px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .task-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
        .task-card h3 { font-size: 1.5rem; color: #000000; margin-bottom: 1rem; }
        .task-card p { font-size: 1rem; color: #000000; margin: 0.5rem 0; }
        .task-card p strong { color: #000000; }
        .no-tasks { font-size: 1.2rem; color: #000000; text-align: center; margin-top: 2rem; }
        .cta-button { display: inline-block; padding: 0.8rem 1.5rem; background: #3498db; color: #FFFFFF; text-decoration: none; border-radius: 8px; font-size: 1rem; transition: background 0.3s ease; cursor: pointer; border: none; }
        .cta-button:hover { background: #2980b9; }
        .action-btn { padding: 0.5rem 1rem; background: #e74c3c; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-top: 1rem; }
        .action-btn:hover { background: #c0392b; }
        .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 2000; }
        .popup-content { background: #FFFFFF; border-radius: 15px; padding: 2rem; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #000000; cursor: pointer; }
        .close-btn:hover { color: #e74c3c; }
        .popup-content h2 { font-size: 1.8rem; color: #000000; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; color: #000000; margin-bottom: 0.5rem; }
        .custom-input, .custom-dropdown { width: 100%; padding: 0.8rem; border: 1px solid #000000; border-radius: 8px; font-size: 1rem; color: #000000; transition: border-color 0.3s ease; }
        .custom-input:focus, .custom-dropdown:focus { border-color: #3498db; outline: none; }
        .custom-input[readonly] { background: #F0F0F0; }
        .payment-info { font-size: 0.9rem; color: #000000; margin-top: 0.5rem; }
        footer { background: #FFFFFF; padding: 1rem; text-align: center; position: fixed; bottom: 0; width: 100%; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Taska Elite</div>
        <ul class="nav-menu">
            <li><a href="overview.html">Overview</a></li>

            <li><a href="connections.html">Connections</a></li>
            <li><a href="explore.html">Explore</a></li>

            <li><a href="tasks.html" class="active">Tasks</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="../index.html">Logout</a></li>
        </ul>
        <div class="hamburger">â˜°</div>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">ðŸŒ™</button>
    </nav>

    <main class="dashboard-content">
        <section class="dashboard-section">
            <h1>Your Task Management</h1>
            <p>Assign and track tasks with connected students to streamline your workload.</p>

            <div class="tasks-section">
                <h2>Assigned Tasks</h2>
                <div class="tasks-grid" id="tasks-grid"></div>
                <p class="no-tasks" id="no-tasks" style="display: none;">No tasks assigned yet.</p>
            </div>

            <div class="new-task-section">
                <h2>Add New Task</h2>
                <button class="cta-button" id="add-task-btn">Add Task</button>
            </div>
        </section>
    </main>

    <footer>
        <p>Â© 2025 Taska Elite. All rights reserved. | <a href="#" class="privacy-policy">Privacy Policy</a></p>
    </footer>

    <div class="popup" id="task-popup">
        <div class="popup-content">
            <span class="close-btn" onclick="closeTaskPopup()">Ã—</span>
            <h2>Assign New Task</h2>
            <form id="task-form">
                <div id="step-1">
                    <div class="form-group">
                        <label for="task-name">Task Name:</label>
                        <select id="task-name" class="custom-dropdown" required>
                            <option value="">Select a Task</option>
                            <option value="PPT Making">PPT Making</option>
                            <option value="Research">Research</option>
                            <option value="Code Debug">Code Debug</option>
                            <option value="Content Writing">Content Writing</option>
                            <option value="Data Entry">Data Entry</option>
                            <option value="Spreadsheets">Spreadsheets</option>
                            <option value="Graphic Design">Graphic Design</option>
                            <option value="Video Editing">Video Editing</option>
                            <option value="Web Development">Web Development</option>
                            <option value="Data Analysis">Data Analysis</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Transcription">Transcription</option>
                            <option value="Schedule Management">Schedule Management</option>
                            <option value="Proofreading">Proofreading</option>
                            <option value="Cloud Management">Cloud Management</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-deadline">Deadline:</label>
                        <input type="date" id="task-deadline" class="custom-input" required>
                    </div>
                    <div class="form-group">
                        <label for="task-student">Assign to Student:</label>
                        <select id="task-student" class="custom-dropdown" required>
                            <option value="">Select a Connected Student</option>
                        </select>
                    </div>
                    <button type="button" class="cta-button" id="next-btn">Next</button>
                </div>
                <div id="step-2" style="display: none;">
                    <div class="form-group">
                        <label for="task-payment">Payment (Coins):</label>
                        <input type="number" id="task-payment" class="custom-input" readonly>
                        <p class="payment-info">Payment calculated based on task complexity, student experience, and deadline.</p>
                    </div>
                    <button type="submit" class="cta-button">Assign Task</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, onValue, push, get, set, remove } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDZIDlEtaNRxODoFhRw0xF2yYFBqqBexqo",
            authDomain: "taska-45011.firebaseapp.com",
            databaseURL: "https://taska-45011-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taska-45011",
            storageBucket: "taska-45011.firebasestorage.app",
            messagingSenderId: "205487498813",
            appId: "1:205487498813:web:0de2c9eab567482781ec54"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const userId = localStorage.getItem('userId');

        if (!userId) {
            setTimeout(() => {
                alert("Please log in or sign up first.");
                window.location.href = '../login.html';
            }, 1000);
        } else {
            loadConnectedStudents();
            loadTasks();
        }

        document.getElementById('add-task-btn').addEventListener('click', openTaskPopup);
        document.getElementById('next-btn').addEventListener('click', showStep2);

        function openTaskPopup() {
            const popup = document.getElementById('task-popup');
            popup.style.display = 'flex';
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('task-form').reset();
        }

        function closeTaskPopup() {
            document.getElementById('task-popup').style.display = 'none';
        }

        function loadConnectedStudents() {
            const studentSelect = document.getElementById('task-student');
            onValue(ref(db, `professionalslist/${userId}/connections`), (snapshot) => {
                studentSelect.innerHTML = '<option value="">Select a Connected Student</option>';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const studentId = childSnapshot.key;
                        get(ref(db, `studentslist/${studentId}`)).then((snap) => {
                            const student = snap.val();
                            studentSelect.innerHTML += `<option value="${studentId}">${student.name}</option>`;
                        });
                    });
                } else {
                    studentSelect.innerHTML += '<option value="">No connected students</option>';
                }
            });
        }

        function calculatePayment(taskName, deadline, studentId) {
            const baseCoins = {
                "PPT Making": 400, "Research": 600, "Code Debug": 500, "Content Writing": 450,
                "Data Entry": 300, "Spreadsheets": 350, "Graphic Design": 550, "Video Editing": 600,
                "Web Development": 700, "Data Analysis": 650, "Documentation": 400, "Transcription": 350,
                "Schedule Management": 300, "Proofreading": 400, "Cloud Management": 500
            };
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const daysLeft = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
            const urgencyFactor = daysLeft <= 5 ? 1.3 : 1.0;

            return get(ref(db, `studentslist/${studentId}`)).then((snap) => {
                const student = snap.val();
                const experienceFactor = student.experience ? (1 + (student.experience / 10)) : 1.0;
                const base = baseCoins[taskName] || 400;
                return Math.round(base * urgencyFactor * experienceFactor);
            });
        }

        function showStep2() {
            const taskName = document.getElementById('task-name').value;
            const taskDeadline = document.getElementById('task-deadline').value;
            const taskStudent = document.getElementById('task-student').value;

            if (taskName && taskDeadline && taskStudent) {
                calculatePayment(taskName, taskDeadline, taskStudent).then((payment) => {
                    document.getElementById('task-payment').value = payment;
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                });
            } else {
                alert('Please fill all fields before proceeding.');
            }
        }

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskName = document.getElementById('task-name').value;
            const taskDeadline = document.getElementById('task-deadline').value;
            const taskStudent = document.getElementById('task-student').value;
            const taskPayment = document.getElementById('task-payment').value;

            if (taskName && taskDeadline && taskStudent && taskPayment) {
                const taskData = {
                    name: taskName,
                    deadline: taskDeadline,
                    payment: parseInt(taskPayment),
                    studentId: taskStudent,
                    proId: userId,
                    status: 'pending',
                    assignedAt: new Date().toISOString()
                };
                try {
                    const taskRef = await push(ref(db, 'tasks'));
                    await Promise.all([
                        set(ref(db, `professionalslist/${userId}/tasks/${taskRef.key}`), taskData),
                        set(ref(db, `studentslist/${taskStudent}/tasks/${taskRef.key}`), taskData)
                    ]);
                    alert('Task assigned successfully!');
                    closeTaskPopup();
                } catch (error) {
                    alert('Failed to assign task: ' + error.message);
                }
            }
        });

        function loadTasks() {
            const tasksGrid = document.getElementById('tasks-grid');
            const noTasks = document.getElementById('no-tasks');
            onValue(ref(db, `professionalslist/${userId}/tasks`), (snapshot) => {
                tasksGrid.innerHTML = '';
                if (snapshot.exists()) {
                    noTasks.style.display = 'none';
                    snapshot.forEach((childSnapshot) => {
                        const task = childSnapshot.val();
                        const taskId = childSnapshot.key;
                        get(ref(db, `studentslist/${task.studentId}`)).then((snap) => {
                            const student = snap.val();
                            tasksGrid.innerHTML += `
                                <div class="task-card">
                                    <h3>${task.name}</h3>
                                    <p><strong>Deadline:</strong> ${new Date(task.deadline).toLocaleDateString()}</p>
                                    <p><strong>Payment:</strong> ${task.payment} Coins</p>
                                    <p><strong>Assigned to:</strong> ${student.name}</p>
                                    <p><strong>Status:</strong> ${task.status}</p>
                                    <button class="action-btn" onclick="deleteTask('${taskId}', '${task.studentId}')">Delete Task</button>
                                </div>
                            `;
                        });
                    });
                } else {
                    noTasks.style.display = 'block';
                }
            });
        }

        window.deleteTask = async (taskId, studentId) => {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    await Promise.all([
                        remove(ref(db, `professionalslist/${userId}/tasks/${taskId}`)),
                        remove(ref(db, `studentslist/${studentId}/tasks/${taskId}`))
                    ]);
                    alert('Task deleted successfully!');
                } catch (error) {
                    alert('Failed to delete task: ' + error.message);
                }
            }
        };

        window.onclick = (event) => {
            const popup = document.getElementById('task-popup');
            if (event.target === popup) closeTaskPopup();
        };
    </script>
    <script src="../js/main.js"></script>
</body>
</html>