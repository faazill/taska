<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska Elite - Student Tasks</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { 
            background: #f8f9fa; 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        .navbar { 
            background: #fff; 
            padding: 1rem 2rem; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid #e0e0e0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .navbar .logo { 
            font-size: 1.5rem; 
            color: #1a1a1a; 
        }
        .navbar .nav-menu { 
            display: flex; 
            gap: 1.5rem; 
            list-style: none; 
        }
        .navbar .nav-menu li a { 
            color: #1a1a1a; 
            text-decoration: none; 
            font-size: 1rem; 
            transition: color 0.3s; 
        }
        .navbar .nav-menu li a.active { 
            color: #6c757d; 
        }
        .navbar .hamburger { 
            display: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: #1a1a1a; 
        }
        .dashboard-content { 
            display: flex; 
            flex: 1; 
            margin-top: 3rem; 
            height: calc(100vh - 60px); 
        }
        .sidebar-left { 
            width: 30%; 
            background: #fff; 
            border-right: 1px solid #e0e0e0; 
            overflow-y: auto; 
            min-width: 200px; 
            max-width: 400px; 
        }
        .sidebar-left h3 { 
            font-size: 1.2rem; 
            color: #1a1a1a; 
            padding: 1rem; 
            margin: 0; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .user-item { 
            display: flex; 
            align-items: center; 
            padding: 0.75rem 1rem; 
            margin: 0.25rem 0; 
            cursor: pointer; 
            transition: background 0.3s; 
        }
        .user-item:hover { 
            background: #f1f3f5; 
        }
        .user-item .profile-pic { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            margin-right: 0.75rem; 
            object-fit: cover; 
        }
        .user-item .user-info { 
            color: #1a1a1a; 
        }
        .user-item .user-info .name { 
            font-size: 0.95rem; 
            margin-bottom: 0.1rem; 
        }
        .user-item .user-info .last-message { 
            font-size: 0.85rem; 
            color: #6c757d; 
        }
        .user-item.active { 
            background: #f1f3f5; 
        }
        .user-item.active .user-info .name,
        .user-item.active .user-info .last-message { 
            color: #1a1a1a; 
        }
        .chat-area { 
            width: 42%; 
            background: #fff; 
            border-right: 1px solid #e0e0e0; 
            overflow-y: auto; 
            min-width: 200px; 
            max-width: 600px; 
            display: none; 
            position: relative; 
        }
        .chat-header { 
            padding: 1rem; 
            border-bottom: 1px solid #e0e0e0; 
            background: #fff; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        .chat-header .profile-pic { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
        }
        .chat-header .name { 
            font-size: 1rem; 
            font-weight: 600; 
            color: #1a1a1a; 
        }
        .chat-header .title { 
            font-size: 0.85rem; 
            color: #6c757d; 
        }
        .messages { 
            height: calc(100% - 120px); 
            padding: 1rem; 
            overflow-y: auto; 
        }
        .message { 
            padding: 0.5rem 1rem; 
            margin-bottom: 1rem; 
            background: #f8f9fa; 
            border-radius: 12px; 
            max-width: 80%; 
            color: #1a1a1a; 
            font-size: 0.9rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }
        .message.sent { 
            margin-left: auto; 
            background: #fff; 
            border: 1px solid #e0e0e0; 
        }
        .message.received { 
            background: #f8f9fa; 
        }
        .message .message-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 0.5rem; 
        }
        .message .message-header .profile-pic { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            margin-right: 0.5rem; 
            object-fit: cover; 
        }
        .message .message-header .name { 
            font-size: 0.85rem; 
            font-weight: 500; 
            color: #1a1a1a; 
        }
        .message .message-header .time { 
            font-size: 0.75rem; 
            color: #6c757d; 
            margin-left: auto; 
        }
        .chat-input { 
            width: 100%;
            background: #fff;
            padding: 0.75rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            position: sticky; 
            bottom: 0;
        }
        .chat-input input[type="text"] { 
            flex: 1;
            padding: 0.75rem 1.25rem;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            color: #1a1a1a;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .chat-input input[type="text"]:focus { 
            border-color: #6c757d; 
        }
        .chat-input input[type="file"] {
            display: none;
        }
        .chat-input button { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 1.2rem; 
            color: #6c757d; 
            transition: color 0.3s; 
        }
        .chat-input button:hover { 
            color: #1a1a1a; 
        }
        .sidebar-right { 
            width: 30%; 
            background: #fff; 
            overflow-y: auto; 
            min-width: 200px; 
            max-width: 400px; 
            display: none; 
            position: relative;
        }
        .sidebar-right h3 { 
            font-size: 1.2rem; 
            color: #1a1a1a; 
            padding: 1rem; 
            margin: 0; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .workflow-item { 
            background: #fff; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            padding: 1rem; 
            margin: 0.5rem 1rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            transition: transform 0.2s; 
            position: relative; 
        }
        .workflow-item:hover { 
            transform: translateY(-2px); 
        }
        .workflow-item h4 { 
            color: #1a1a1a; 
            font-size: 1rem; 
            margin-bottom: 0.5rem; 
        }
        .workflow-item p { 
            color: #6c757d; 
            font-size: 0.85rem; 
            margin: 0.25rem 0; 
        }
        .workflow-item .status-label {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.75rem;
        }
        .workflow-item .status-label.completed {
            background: #4CAF50;
            color: white;
        }
        .workflow-item .status-label.pending {
            background: #FFC107;
            color: white;
        }
        .workflow-item .status-label.in-progress {
            background: #2196F3;
            color: white;
        }
        .workflow-item .deadline-container {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }
        .workflow-item .deadline-slider {
            height: 5px;
            background: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s;
        }
        .workflow-item .days-left {
            margin-left: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .workflow-item .file-icon { 
            font-size: 1rem; 
            color: #6c757d; 
            margin-top: 0.5rem; 
            cursor: pointer; 
        }
        .completed-tasks { 
            margin: 1rem; 
            padding: 0.5rem; 
            border-top: 1px solid #e0e0e0; 
        }
        .completed-tasks h4 { 
            color: #1a1a1a; 
            font-size: 1rem; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .completed-tasks .toggle-icon { 
            transition: transform 0.3s; 
        }
        .completed-tasks .toggle-icon.active { 
            transform: rotate(180deg); 
        }
        .completed-tasks-list { 
            display: none; 
            margin-top: 0.5rem; 
        }
        .completed-tasks-list.active { 
            display: block; 
        }
        @media (max-width: 768px) {
            .dashboard-content { 
                flex-direction: column; 
                height: auto; 
            }
            .sidebar-left, .chat-area, .sidebar-right { 
                width: 100%; 
                min-width: 0; 
                max-width: none; 
                border: none; 
                border-bottom: 1px solid #e0e0e0; 
            }
            .chat-input { 
                width: 100%; 
                position: relative; 
                bottom: auto; 
            }
            .navbar .nav-menu { 
                display: none; 
                position: absolute; 
                top: 60px; 
                left: 0; 
                right: 0; 
                background: #fff; 
                flex-direction: column; 
                padding: 1rem; 
                border-top: 1px solid #e0e0e0; 
            }
            .navbar .nav-menu.active { 
                display: flex; 
            }
            .navbar .hamburger { 
                display: block; 
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Taska Elite - Student</div>
        <ul class="nav-menu">
            <li><a href="explore.html">Explore</a></li>
            <li><a href="connections.html">Connections</a></li>
            <li><a href="student_tasks.html" class="active">Tasks</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="../index.html">Logout</a></li>
        </ul>
        <div class="hamburger">☰</div>
    </nav>

    <div class="dashboard-content">
        <div class="sidebar-left">
            <h3>Connected Professionals</h3>
            <div id="connections-list"></div>
        </div>
        <div class="chat-area" id="chat-area">
            <div class="chat-header" id="chat-header"></div>
            <div class="messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <input type="file" id="profile-pic-upload" accept="image/*">
                <button onclick="triggerProfilePicUpload()"><i class="fas fa-user-circle"></i></button>
                <button onclick="uploadImage()"><i class="fas fa-camera"></i></button>
                <button onclick="uploadFile()"><i class="fas fa-link"></i></button>
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div class="sidebar-right" id="workflow-area">
            <h3>My Tasks</h3>
            <div id="workflow-list"></div>
            <div class="completed-tasks">
                <h4 onclick="toggleCompletedTasks()">Completed Tasks <i class="fas fa-chevron-down toggle-icon"></i></h4>
                <div class="completed-tasks-list" id="completed-tasks-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get, push, set, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDZIDlEtaNRxODoFhRw0xF2yYFBqqBexqo",
            authDomain: "taska-45011.firebaseapp.com",
            databaseURL: "https://taska-45011-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taska-45011",
            storageBucket: "taska-45011.appspot.com",
            messagingSenderId: "205487498813",
            appId: "1:205487498813:web:0de2c9eab567482781ec54"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const userId = localStorage.getItem('userId');
        const userRole = localStorage.getItem('userRole');

        if (!userId || userRole !== 'student') {
            alert("Please log in as a student.");
            window.location.href = '../login.html';
        }

        let selectedProfessionalId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hamburger = document.querySelector('.navbar .hamburger');
            const navMenu = document.querySelector('.navbar .nav-menu');
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
            loadConnections();
        });

        async function loadConnections() {
            const connectionsList = document.getElementById('connections-list');
            connectionsList.innerHTML = '';
            try {
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                const users = usersSnapshot.val() || {};
                const connectionsRef = ref(db, `connections/${userId}/connections`);
                const connectionsSnapshot = await get(connectionsRef);
                const studentConnections = connectionsSnapshot.val() || {};

                for (const professionalId in studentConnections) {
                    const professionalConnectionsRef = ref(db, `connections/${professionalId}/connections`);
                    const professionalConnectionsSnapshot = await get(professionalConnectionsRef);
                    const professionalConnections = professionalConnectionsSnapshot.val() || {};

                    if (professionalConnections[userId] && users[professionalId]?.role === 'professional') {
                        const user = users[professionalId];
                        const chatId = `${professionalId}_${userId}`;
                        const chatRef = ref(db, `chat/${chatId}/messages`);
                        const chatSnapshot = await get(chatRef);
                        const messages = chatSnapshot.val() || {};
                        const lastMessage = Object.values(messages).slice(-1)[0]?.content || "No messages yet";
                        const profilePic = user.profilePic || '../assets/avatar/default.jpg';

                        connectionsList.innerHTML += `
                            <div class="user-item" data-professional-id="${professionalId}" onclick="selectProfessional('${professionalId}')">
                                <img src="${profilePic}" alt="${user.name || 'Unknown'}" class="profile-pic">
                                <div class="user-info">
                                    <div class="name">${user.name || 'Unknown'}</div>
                                    <div class="last-message">${lastMessage}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error("Failed to load connections:", error);
            }
        }

        function selectProfessional(professionalId) {
            selectedProfessionalId = professionalId;
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.toggle('active', item.dataset.professionalId === professionalId);
            });
            document.getElementById('chat-area').style.display = 'block';
            document.getElementById('workflow-area').style.display = 'block';
            loadChat();
            loadWorkflows();
            loadChatHeader();
        }

        async function loadChatHeader() {
            const chatHeader = document.getElementById('chat-header');
            try {
                const userRef = ref(db, `users/${selectedProfessionalId}`);
                const snapshot = await get(userRef);
                const user = snapshot.val() || {};
                const profilePic = user.profilePic || '../assets/avatar/default.jpg';
                chatHeader.innerHTML = `
                    <img src="${profilePic}" alt="${user.name || 'Unknown'}" class="profile-pic">
                    <div>
                        <div class="name">${user.name || 'Unknown'}</div>
                        <div class="title">${user.title || ''}</div>
                    </div>
                `;
            } catch (error) {
                console.error("Failed to load chat header:", error);
            }
        }

        async function loadChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            if (selectedProfessionalId) {
                const chatId = `${selectedProfessionalId}_${userId}`;
                const messagesRef = ref(db, `chat/${chatId}/messages`);
                onValue(messagesRef, async (snapshot) => {
                    chatMessages.innerHTML = '';
                    const messages = snapshot.val() || {};
                    const usersRef = ref(db, 'users');
                    const usersSnapshot = await get(usersRef);
                    const users = usersSnapshot.val() || {};

                    for (const msgId in messages) {
                        const msg = messages[msgId];
                        const isSent = msg.senderId === userId;
                        const sender = users[msg.senderId] || { name: 'Unknown' };
                        const profilePic = sender.profilePic || '../assets/avatar/default.jpg';
                        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const date = new Date(msg.timestamp).toLocaleDateString();
                        chatMessages.innerHTML += `
                            <div class="message ${isSent ? 'sent' : 'received'}">
                                <div class="message-header">
                                    <img src="${profilePic}" alt="${sender.name}" class="profile-pic">
                                    <div class="name">${sender.name}</div>
                                    <div class="time">${date} ${time}</div>
                                </div>
                                ${msg.content}
                            </div>
                        `;
                    }
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (content && selectedProfessionalId) {
                const chatId = `${selectedProfessionalId}_${userId}`;
                const messagesRef = ref(db, `chat/${chatId}/messages`);
                try {
                    await push(messagesRef, {
                        senderId: userId,
                        content,
                        timestamp: new Date().toISOString()
                    });
                    input.value = '';
                } catch (error) {
                    console.error("Failed to send message:", error);
                    alert("Failed to send message.");
                }
            }
        }

        function triggerProfilePicUpload() {
            document.getElementById('profile-pic-upload').click();
        }

        async function uploadProfilePic() {
            const fileInput = document.getElementById('profile-pic-upload');
            const file = fileInput.files[0];
            if (file) {
                try {
                    const profileRef = storageRef(storage, `profile/${userId}/profile.jpg`);
                    await uploadBytes(profileRef, file);
                    const downloadURL = await getDownloadURL(profileRef);
                    const userRef = ref(db, `users/${userId}`);
                    await set(userRef, { profilePic: downloadURL }, { merge: true });
                    alert("Profile picture updated!");
                    loadConnections(); // Refresh to show new picture
                } catch (error) {
                    console.error("Failed to upload profile picture:", error);
                    alert("Failed to upload profile picture.");
                }
            }
        }

        document.getElementById('profile-pic-upload').addEventListener('change', uploadProfilePic);

        function uploadFile() { alert("Upload file functionality to be implemented."); }
        function uploadImage() { alert("Upload image functionality to be implemented."); }

        async function loadWorkflows() {
            const workflowList = document.getElementById('workflow-list');
            workflowList.innerHTML = '';
            try {
                const tasksRef = ref(db, 'tasks');
                const snapshot = await get(tasksRef);
                const tasks = snapshot.val() || {};

                for (const workflowId in tasks) {
                    const workflow = tasks[workflowId];
                    if (workflow.studentId === userId && workflow.professionalId === selectedProfessionalId && workflow.status !== 'completed') {
                        const statusClass = workflow.status === "pending" ? "pending" : "in-progress";
                        workflowList.innerHTML += `
                            <div class="workflow-item">
                                <span class="status-label ${statusClass}">${workflow.status.charAt(0).toUpperCase() + workflow.status.slice(1)}</span>
                                <h4>${workflow.title}</h4>
                                <p>${workflow.description}</p>
                                <div class="deadline-container">
                                    <div class="deadline-slider" style="width: ${calculateDeadlineProgress(workflow.deadline)}%; background: #4CAF50;"></div>
                                    <span class="days-left">${calculateDaysLeft(workflow.deadline)} days left</span>
                                </div>
                                <p>Payment: $${workflow.payment}</p>
                                <i class="fas fa-file-alt file-icon" title="${workflow.document || 'No file'}"></i>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error("Failed to load workflows:", error);
            }
        }

        async function loadCompletedTasks() {
            const completedTasksList = document.getElementById('completed-tasks-list');
            completedTasksList.innerHTML = '';
            try {
                const tasksRef = ref(db, 'tasks');
                const snapshot = await get(tasksRef);
                const tasks = snapshot.val() || {};

                for (const workflowId in tasks) {
                    const workflow = tasks[workflowId];
                    if (workflow.studentId === userId && workflow.professionalId === selectedProfessionalId && workflow.status === 'completed') {
                        completedTasksList.innerHTML += `
                            <div class="workflow-item">
                                <span class="status-label completed">Completed</span>
                                <h4>${workflow.title}</h4>
                                <p>${workflow.description}</p>
                                <div class="deadline-container">
                                    <div class="deadline-slider" style="width: 0%; background: #4CAF50;"></div>
                                    <span class="days-left">0 days left</span>
                                </div>
                                <p>Payment: $${workflow.payment}</p>
                                <i class="fas fa-file-alt file-icon" title="${workflow.document || 'No file'}"></i>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error("Failed to load completed tasks:", error);
            }
        }

        function toggleCompletedTasks() {
            const completedTasksList = document.getElementById('completed-tasks-list');
            const toggleIcon = document.querySelector('.completed-tasks .toggle-icon');
            completedTasksList.classList.toggle('active');
            toggleIcon.classList.toggle('active');
        }

        function calculateDaysLeft(deadline) {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        function calculateDeadlineProgress(deadline) {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const totalTime = deadlineDate - new Date(deadline.split('-')[0], 0, 1);
            const remainingTime = deadlineDate - now;
            const progress = (remainingTime / totalTime) * 100;
            return Math.max(0, Math.min(100, progress));
        }
    </script>
</body>
</html>